
## Review

we have following benchmarks to do:

* time to copy data to SLURM_TMPDIR and SLURM_RAM_TMPDIR - 2 min for 10k files
* load binary representation of jpeg (lmdb, hdf5, scratch, SLURM_TMPDIR, SLURM_RAM_TMPDIR)
* load binary and convert to numpy one by one, vs load all in binary format and then convert to numpy - same
* load binary and convert to numpy vs load data stored as numpy - 10 times faster read from numpy




## Prepare

use commands inside 'create_subset_of_files.sh' to prepare subset of data

```
srun --ntasks-per-node=1 --nodes 1 --mem=20GB -t2:00:00 --pty /bin/bash
module load  anaconda3/5.3.1
source /share/apps/anaconda3/2019.10/etc/profile.d/conda.sh
conda activate ./penv/
python3
```

Run files as

```
exec(open("<filename>.py").read())
```

* create hdf5 and lmdb files
  + create_subset_of_files.sh
  + run write_jpg_hdf5_10000.py
  + run write_jpg_lmdb_10000.py
* read test
  + adjust file read_test_binary.py and read_test_numpy.py as needed
  + run batch job with slurm_send file



## Write

Note: The first run of any of those, may be 10 times slower - it seams numbers bellow are after /scratch cache kiked in.

### write_jpg_hdf5_10000.py
Process took: 6.434529066085815

### write_jpg_lmdb_10000.py
Process took: 3.7442269325256348

### write_numpy_hdf5_10000.py
Process took: 9.161472797393799

### write_numpy_lmdb_10000.py
Process took: 6.790677309036255

### Compare size for all

* directory with jpg files
308M    data_10000/

* data files
17M  hdf5-jpg-10000.hdf5
109M hdf5-numpy-10000.hdf5
4.0K lmdb-jpg-10000.lmdb
4.0K lmdb-numpy-10000.lmdb

* meta data files
460K hdf5-jpg-10000.sqlite
524K hdf5-numpy-10000.sqlite
700K lmdb-jpg-10000.sqlite
700K lmdb-numpy-10000.sqlite


## Read

### SLURM_TMPDIR and SLUMR_RAM_TMPDIR

There is no point to display read speed from SLURM_TMPDIR or SLURM_RAM_TMPDIR. In both cases we first copy files to a corresponding SLURM directory. OS can cache files during this operation. Read time in this case is very fast. 
However the slowest part in this case is copy to a SLURM directory. This time is 


copy to SLURM_TMPDIR process took (included in total bellow): 66.26729846000671
copy to SLURM_RAM_TMPDIR process took (included in total bellow): 2.006354331970215

### Binary, sequential


#### no convert

{'lmdb': [0.0003695487976074219, 0.0012018680572509766, 0.0021173954010009766, 0.0066680908203125, 0.011558294296264648, 0.01822185516357422, 0.021173715591430664], 'hdf5': [0.012168407440185547, 0.05112719535827637, 0.10198116302490234, 0.3015875816345215, 0.49755263328552246, 0.798105001449585, 0.9898452758789062], 'scratch': [0.016802310943603516, 0.08235430717468262, 0.16387343406677246, 0.49456071853637695, 0.821256160736084, 1.3139708042144775, 1.6404242515563965], 'SLURM_TMPDIR': [0.0009763240814208984, 0.004647016525268555, 0.008950948715209961, 0.027919530868530273, 0.04474997520446777, 0.07147932052612305, 0.08677554130554199], 'SLURM_RAM_TMPDIR': [0.0007994174957275391, 0.004105567932128906, 0.008220195770263672, 0.025756359100341797, 0.04139828681945801, 0.0654299259185791, 0.07948017120361328], 'convert': [0, 0, 0, 0, 0, 0, 0], 'subset_of_paths': [0.0006651878356933594, 0.0003268718719482422, 0.00029850006103515625, 0.0008013248443603516, 0.00034689903259277344, 0.0007843971252441406, 0.00040912628173828125], 'N_to_read': [100, 500, 1000, 3000, 5000, 8000, 9999]}
       lmdb   hdf5  scratch  SLURM_TMPDIR  SLURM_RAM_TMPDIR
500   0.001  0.051    0.082         0.005             0.004
1000  0.002  0.102    0.164         0.009             0.008
3000  0.007  0.302    0.495         0.028             0.026
5000  0.012  0.498    0.821         0.045             0.041
8000  0.018  0.798    1.314         0.071             0.065
9999  0.021  0.990    1.640         0.087             0.079
Time to convert the whole array is 1.319047212600708

#### convert

{'lmdb': [0.29138946533203125, 0.0727226734161377, 0.14284253120422363, 0.4337809085845947, 0.7202503681182861, 1.1462843418121338, 1.4194848537445068], 'hdf5': [0.29730916023254395, 0.15387725830078125, 0.30599260330200195, 0.9174892902374268, 1.6527693271636963, 2.4311115741729736, 3.031364917755127], 'scratch': [0.0367436408996582, 0.1842176914215088, 0.3710455894470215, 1.120701789855957, 1.8591718673706055, 2.972684621810913, 3.70064377784729], 'SLURM_TMPDIR': [0.01631307601928711, 0.08147764205932617, 0.1611802577972412, 0.48946642875671387, 0.8073911666870117, 1.2862269878387451, 1.5751476287841797], 'SLURM_RAM_TMPDIR': [0.01749110221862793, 0.08033418655395508, 0.15967774391174316, 0.48360610008239746, 0.7988429069519043, 1.2758078575134277, 1.5671164989471436], 'convert': [0.29077935218811035, 0.07033872604370117, 0.13842105865478516, 0.42040300369262695, 0.6983168125152588, 1.1112794876098633, 1.3771989345550537], 'subset_of_paths': [0.0008687973022460938, 0.0010437965393066406, 0.00033354759216308594, 0.0010416507720947266, 0.001049041748046875, 0.0010561943054199219, 0.0004611015319824219], 'N_to_read': [100, 500, 1000, 3000, 5000, 8000, 9999]}
       lmdb   hdf5  scratch  SLURM_TMPDIR  SLURM_RAM_TMPDIR
500   0.073  0.154    0.184         0.081             0.080
1000  0.143  0.306    0.371         0.161             0.160
3000  0.434  0.917    1.121         0.489             0.484
5000  0.720  1.653    1.859         0.807             0.799
8000  1.146  2.431    2.973         1.286             1.276
9999  1.419  3.031    3.701         1.575             1.567



### Binary, random

#### no convert

{'lmdb': [0.0005018711090087891, 0.0015654563903808594, 0.002997875213623047, 0.009137630462646484, 0.014460086822509766, 0.022918701171875, 0.024948835372924805], 'hdf5': [0.019595623016357422, 0.07232213020324707, 0.14302873611450195, 0.42592287063598633, 0.7040121555328369, 1.110708236694336, 1.4090378284454346], 'scratch': [0.0168459415435791, 0.08315062522888184, 0.1687626838684082, 0.5044190883636475, 0.8338618278503418, 1.3434815406799316, 1.678229570388794], 'SLURM_TMPDIR': [0.0012011528015136719, 0.0056514739990234375, 0.012550592422485352, 0.03210306167602539, 0.05104947090148926, 0.07835745811462402, 0.09139490127563477], 'SLURM_RAM_TMPDIR': [0.0009009838104248047, 0.004431724548339844, 0.008933782577514648, 0.026984691619873047, 0.044278621673583984, 0.07030582427978516, 0.08521151542663574], 'convert': [0, 0, 0, 0, 0, 0, 0], 'subset_of_paths': [0.0006825923919677734, 0.00024700164794921875, 0.00048065185546875, 0.0008401870727539062, 0.0008568763732910156, 0.0014209747314453125, 0.0013256072998046875], 'N_to_read': [100, 500, 1000, 3000, 5000, 8000, 9999]}
       lmdb   hdf5  scratch  SLURM_TMPDIR  SLURM_RAM_TMPDIR
500   0.002  0.072    0.083         0.006             0.004
1000  0.003  0.143    0.169         0.013             0.009
3000  0.009  0.426    0.504         0.032             0.027
5000  0.014  0.704    0.834         0.051             0.044
8000  0.023  1.111    1.343         0.078             0.070
9999  0.025  1.409    1.678         0.091             0.085
Time to convert the whole array is 1.3267643451690674


#### convet

{'lmdb': [0.02493572235107422, 0.07196998596191406, 0.14477014541625977, 0.43451690673828125, 0.7238519191741943, 1.155421495437622, 1.4185726642608643], 'hdf5': [0.04280805587768555, 0.18741440773010254, 0.36383724212646484, 1.0980961322784424, 1.8265631198883057, 2.935312271118164, 3.6651971340179443], 'scratch': [0.0391082763671875, 0.18524384498596191, 0.3704512119293213, 1.1257538795471191, 1.864976406097412, 2.9769983291625977, 3.7208621501922607], 'SLURM_TMPDIR': [0.016344308853149414, 0.0824580192565918, 0.16295981407165527, 0.4992716312408447, 0.814457893371582, 1.2969131469726562, 1.5825860500335693], 'SLURM_RAM_TMPDIR': [0.015819549560546875, 0.08079385757446289, 0.16002178192138672, 0.48544812202453613, 0.8020989894866943, 1.282843828201294, 1.5727448463439941], 'convert': [0.024216413497924805, 0.06924128532409668, 0.1392359733581543, 0.4190483093261719, 0.6987073421478271, 1.1177170276641846, 1.373802900314331], 'subset_of_paths': [0.000858306884765625, 0.0011339187622070312, 0.00043463706970214844, 0.0013697147369384766, 0.0015170574188232422, 0.0017986297607421875, 0.00215911865234375], 'N_to_read': [100, 500, 1000, 3000, 5000, 8000, 9999]}
       lmdb   hdf5  scratch  SLURM_TMPDIR  SLURM_RAM_TMPDIR
500   0.072  0.187    0.185         0.082             0.081
1000  0.145  0.364    0.370         0.163             0.160
3000  0.435  1.098    1.126         0.499             0.485
5000  0.724  1.827    1.865         0.814             0.802
8000  1.155  2.935    2.977         1.297             1.283
9999  1.419  3.665    3.721         1.583             1.573


### Numpy, sequential (read_test_numpy)

{'lmdb_convert': [0.3247833251953125, 0.09873843193054199, 0.20233416557312012, 0.6290090084075928, 1.1506638526916504, 1.6593105792999268, 2.0744245052337646], 'lmdb_numpy': [0.09183692932128906, 0.008666515350341797, 0.019803762435913086, 0.059500694274902344, 0.10065174102783203, 0.2522275447845459, 0.19154715538024902], 'hdf5_convert': [0.27440905570983887, 0.20958948135375977, 0.42492175102233887, 1.2774977684020996, 2.1611485481262207, 3.4003007411956787, 4.301417827606201], 'hdf5_numpy': [0.27281785011291504, 0.503826379776001, 1.0110251903533936, 3.0291149616241455, 5.040998935699463, 8.159148693084717, 10.057250738143921], 'scratch_convert': [1.2628040313720703, 3.5546376705169678, 4.279931545257568, 15.903003931045532, 14.239200115203857, 20.608097076416016, 16.131174087524414], 'convert': [0.32385754585266113, 0.09532499313354492, 0.1956775188446045, 0.6078140735626221, 1.1121876239776611, 1.6025526523590088, 2.0036509037017822], 'subset_of_paths': [0.000308990478515625, 0.000354766845703125, 0.0004012584686279297, 0.0008466243743896484, 0.0007703304290771484, 0.0007047653198242188, 0.0006489753723144531], 'N_to_read': [100, 500, 1000, 3000, 5000, 8000, 9999]}
      lmdb_convert  lmdb_numpy  hdf5_convert  hdf5_numpy  scratch_convert
500          0.099       0.009         0.210       0.504            3.555
1000         0.202       0.020         0.425       1.011            4.280
3000         0.629       0.060         1.277       3.029           15.903
5000         1.151       0.101         2.161       5.041           14.239
8000         1.659       0.252         3.400       8.159           20.608
9999         2.074       0.192         4.301      10.057           16.131


### Numpy, random (read_test_numpy)

{'lmdb_convert': [0.022388219833374023, 0.0691070556640625, 0.1430366039276123, 0.4339277744293213, 0.7265269756317139, 1.1620521545410156, 1.4379220008850098], 'lmdb_numpy': [0.09197664260864258, 0.02431035041809082, 0.021117687225341797, 0.05965781211853027, 0.0818319320678711, 0.11339426040649414, 0.13934087753295898], 'hdf5_convert': [0.040674448013305664, 0.18971800804138184, 0.3774886131286621, 1.142594337463379, 1.9229013919830322, 3.1389451026916504, 3.969083070755005], 'hdf5_numpy': [1.5794503688812256, 3.438089370727539, 3.030247449874878, 3.661686658859253, 4.809145450592041, 6.69336199760437, 8.159472227096558], 'scratch_convert': [0.036681175231933594, 0.18164706230163574, 0.3802001476287842, 1.0960612297058105, 1.824772834777832, 2.913545846939087, 3.64190936088562], 'convert': [0.021785736083984375, 0.06658148765563965, 0.13792634010314941, 0.41891050338745117, 0.7019710540771484, 1.123070478439331, 1.390460729598999], 'subset_of_paths': [0.00029349327087402344, 0.0004608631134033203, 0.0008153915405273438, 0.0008838176727294922, 0.0011069774627685547, 0.0012056827545166016, 0.0015714168548583984], 'N_to_read': [100, 500, 1000, 3000, 5000, 8000, 9999]}
      lmdb_convert  lmdb_numpy  hdf5_convert  hdf5_numpy  scratch_convert
500          0.069       0.024         0.190       3.438            0.182
1000         0.143       0.021         0.377       3.030            0.380
3000         0.434       0.060         1.143       3.662            1.096
5000         0.727       0.082         1.923       4.809            1.825
8000         1.162       0.113         3.139       6.693            2.914
9999         1.438       0.139         3.969       8.159            3.642


## Copy lmdb or hdf5 to local disk of compute node


### Sequential, no conversion

No significant difference in performance observed

{'lmdb': [0.0005164146423339844, 0.0014562606811523438, 0.0027239322662353516, 0.007801532745361328, 0.01283407211303711, 0.020449161529541016, 0.025189876556396484], 'hdf5': [0.007646799087524414, 0.00705409049987793, 0.013166189193725586, 0.035188913345336914, 0.057166099548339844, 0.08978414535522461, 0.1108560562133789], 'scratch': [0.02277970314025879, 0.11513304710388184, 0.22476601600646973, 0.6729824542999268, 1.1145431995391846, 1.7913038730621338, 2.220292091369629], 'SLURM_TMPDIR': [0.001657247543334961, 0.007478237152099609, 0.01391744613647461, 0.04364490509033203, 0.07034921646118164, 0.11157917976379395, 0.13174939155578613], 'SLURM_RAM_TMPDIR': [0, 0, 0, 0, 0, 0, 0], 'convert': [0, 0, 0, 0, 0, 0, 0], 'subset_of_paths': [0.0009276866912841797, 0.0004100799560546875, 0.0004029273986816406, 0.0004131793975830078, 0.00041961669921875, 0.0004398822784423828, 0.00040602684020996094], 'lmdb_local': [0.0003628730773925781, 0.0012025833129882812, 0.0022199153900146484, 0.006617546081542969, 0.01066732406616211, 0.01693105697631836, 0.02120494842529297], 'hdf5_local': [0.0023627281188964844, 0.0065686702728271484, 0.012087821960449219, 0.03386974334716797, 0.05522346496582031, 0.08639144897460938, 0.1325969696044922], 'N_to_read': [100, 500, 1000, 3000, 5000, 8000, 9999]}
       lmdb   hdf5  scratch  SLURM_TMPDIR  SLURM_RAM_TMPDIR  lmdb_local  hdf5_local
500   0.001  0.007    0.115         0.007                 0       0.001       0.007
1000  0.003  0.013    0.225         0.014                 0       0.002       0.012
3000  0.008  0.035    0.673         0.044                 0       0.007       0.034
5000  0.013  0.057    1.115         0.070                 0       0.011       0.055
8000  0.020  0.090    1.791         0.112                 0       0.017       0.086
9999  0.025  0.111    2.220         0.132                 0       0.021       0.133

### Random, no conversion
  
  
{'lmdb': [0.0006840229034423828, 0.003192424774169922, 0.003674030303955078, 0.008788585662841797, 0.015293598175048828, 0.020221948623657227, 0.024515390396118164], 'hdf5': [0.010602951049804688, 0.03732132911682129, 0.053640127182006836, 0.27100443840026855, 0.5780549049377441, 0.6064190864562988, 0.10915470123291016], 'scratch': [1.553091049194336, 5.650216102600098, 10.793004751205444, 26.230822801589966, 29.469286680221558, 23.379844427108765, 7.338810205459595], 'SLURM_TMPDIR': [0.002398967742919922, 0.005903720855712891, 0.012823343276977539, 0.03702735900878906, 0.05199122428894043, 0.07904839515686035, 0.09081292152404785], 'SLURM_RAM_TMPDIR': [0, 0, 0, 0, 0, 0, 0], 'convert': [0, 0, 0, 0, 0, 0, 0], 'subset_of_paths': [0.0007112026214599609, 0.0005106925964355469, 0.0007531642913818359, 0.0006129741668701172, 0.0007042884826660156, 0.0009984970092773438, 0.0009455680847167969], 'lmdb_local': [0.0004584789276123047, 0.0023849010467529297, 0.0030312538146972656, 0.007474422454833984, 0.012073755264282227, 0.01726984977722168, 0.02221393585205078], 'hdf5_local': [0.006119251251220703, 0.03044891357421875, 0.05365395545959473, 0.2884633541107178, 0.6583936214447021, 0.5998215675354004, 0.09996581077575684], 'N_to_read': [100, 500, 1000, 3000, 5000, 8000, 9999]}
       lmdb   hdf5  scratch  SLURM_TMPDIR  SLURM_RAM_TMPDIR  lmdb_local  hdf5_local
500   0.003  0.037    5.650         0.006                 0       0.002       0.030
1000  0.004  0.054   10.793         0.013                 0       0.003       0.054
3000  0.009  0.271   26.231         0.037                 0       0.007       0.288
5000  0.015  0.578   29.469         0.052                 0       0.012       0.658
8000  0.020  0.606   23.380         0.079                 0       0.017       0.600
9999  0.025  0.109    7.339         0.091                 0       0.022       0.100  